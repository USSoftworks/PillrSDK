<Project>
  <Target Condition="$(_IsPublishing) == 'true'" Name="WhenPublished" AfterTargets="Publish" DependsOnTargets="Initialize">
    <PropertyGroup>
    </PropertyGroup>

    <ItemGroup>
      <Archive Include="$(MSBuildThisFileDirectory)$(ProjectName).zip" />
    </ItemGroup>

    <ZipDirectory SourceDirectory="$(ProjectDir)$(PublishDir)" Overwrite="true" DestinationFile="@(Archive)" />

    <Kudu_DeployZip
      Sitename="%(Configuration.KuduSitename)"
      Username="%(Configuration.KuduUsername)"
      Password="%(Configuration.KuduPassword)"
      ZipFile="@(Archive)" IsAsync="false"
    >
      <Output TaskParameter="StatusUri" PropertyName="StatusUri" />
    </Kudu_DeployZip>

    <TaskItemsFromFlatArray Configuration="@(Configuration)" Path="Build:To" MaxLength="8">
      <Output TaskParameter="Items" ItemName="ToAddresses" />
    </TaskItemsFromFlatArray>
    <TaskItemsFromFlatArray ContinueOnError="true" Configuration="@(Configuration)" Path="Build:Cc" MaxLength="8">
      <Output TaskParameter="Items" ItemName="CcAddresses" />
    </TaskItemsFromFlatArray>
    <TaskItemsFromFlatArray ContinueOnError="true" Configuration="@(Configuration)" Path="Build:Bcc" MaxLength="8">
      <Output TaskParameter="Items" ItemName="BccAddresses" />
    </TaskItemsFromFlatArray>

    <SendEmail
      ContinueOnError="true"
      From="@(Configuration->Metadata('SmtpFrom'))"
      To="@(ToAddresses)"
      Cc="@(CcAddresses)"
      Bcc="@(BccAddresses"
      SmtpServer="@(Configuration->Metadata('SmtpServer'))"
      Password="@(Configuration->Metadata('SmtpPassword'))"
      Subject="@(Configuration->Metadata('Build:Subject'))"
      Text="@(Configuration->Metadata('Build:Text'))"
    />

    <!-- TODO Pass the StatusUri to a listening service here OR -->
    <!-- TODO Register a webhook using the Kudu API and handle events -->

    <Delete Files="@(Archive)" TreatErrorsAsWarnings="true" />
  </Target>
</Project>
